<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Automatismes Math√©matiques - Sujet SIXI√àME (mars 2020)</title>
  <!-- KaTeX CSS + JS (deferred) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:900px;margin:0 auto}
    .header{background:#fff;border-radius:20px;padding:30px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center}
    h1{color:#764ba2;font-size:2.2em;margin-bottom:10px}
    .subtitle{color:#666;font-size:1.05em}
    .controls{background:#fff;border-radius:15px;padding:20px;margin-bottom:30px;box-shadow:0 5px 20px rgba(0,0,0,.1);display:flex;gap:20px;flex-wrap:wrap;justify-content:center;align-items:center}
    .control-group{display:flex;align-items:center;gap:10px}
    label{font-weight:700;color:#333}
    select,input[type=number]{padding:8px 12px;border:2px solid #ddd;border-radius:8px;font-size:16px;transition:border-color .3s}
    select:focus,input[type=number]:focus{outline:0;border-color:#667eea}
    button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:0;padding:12px 30px;border-radius:25px;font-size:16px;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 15px rgba(102,126,234,.4)}
    button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.5)}
    .quiz-container{background:#fff;border-radius:20px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.2);min-height:400px}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #eee}
    .question-number{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:8px 16px;border-radius:20px;font-weight:700}
    .timer{font-size:1.2em;color:#666;font-weight:700}
    .mode-info{background:#fff3cd;color:#856404;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center}
    .question-content{margin:30px 0;padding:20px;background:#f8f9fa;border-radius:15px;border-left:4px solid #667eea}
    .question-text{font-size:1.25em;color:#333;line-height:1.6;margin-bottom:20px}
    .math-display{font-size:1.35em;margin:15px 0;text-align:center}
    .answer-input{padding:12px 20px;font-size:18px;border:2px solid #ddd;border-radius:10px;width:300px;max-width:100%}
    .question-actions{display:flex;gap:15px;margin-top:30px}
    .btn-validate{background:#28a745}
    .btn-skip{background:#ffc107}
    .btn-next{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .feedback{margin-top:20px;padding:15px;border-radius:10px;font-weight:700}
    .feedback.correct{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .feedback.incorrect{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .explanation-box{margin-top:15px;padding:15px;border-radius:8px;border-left:3px solid}
    .explanation-box.correct{background:#e8f5e9;border-color:#4caf50}
    .explanation-box.incorrect{background:#ffebee;border-color:#f44336}
    .math-steps{margin-top:10px;line-height:2.1}
    .math-step{display:block;margin:6px 0;font-size:1.05em}
    /* Masque la couche MathML de KaTeX pour √©viter les doublons visuels */
    .katex .katex-mathml{position:absolute!important;clip:rect(1px,1px,1px,1px)!important;clip-path:inset(50%)!important;height:1px!important;width:1px!important;overflow:hidden!important;padding:0!important;border:0!important}
    .katex .katex-html{position:relative}
    .results{text-align:center;padding:40px}
    .score{font-size:3em;color:#667eea;margin:20px 0;font-weight:700}
    .results-details{background:#f8f9fa;padding:20px;border-radius:15px;margin:20px 0}
    .question-review{text-align:left;margin:15px 0;padding:15px;background:#fff;border-radius:8px}
    .question-review.correct{border-left:4px solid #28a745}
    .question-review.incorrect{border-left:4px solid #dc3545}
    .review-explanation{margin-top:10px;padding:10px;background:#f5f5f5;border-radius:5px;border-left:3px solid #9c27b0}
    .time-info{background:#e3f2fd;padding:10px 15px;border-radius:8px;margin:10px 0;color:#1976d2;font-weight:700}
    .figure-container svg{max-width:100%;height:auto;overflow:visible}
    @media (max-width:600px){.controls{flex-direction:column}.control-group{width:100%;justify-content:space-between}h1{font-size:1.6em}}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìê Automatismes ‚Äì Sujet SIXI√àME (mars 2020)</h1>
    <div class="subtitle">Entra√Ænement format √©preuve (30 questions en 9 min, sans calculatrice)</div>
  </div>

  <div class="controls">
    <div class="control-group">
      <label for="questionCount">Nombre de questions:</label>
      <input type="number" id="questionCount" min="5" max="30" value="30" />
    </div>
    <div class="control-group">
      <label for="mode">Mode:</label>
      <select id="mode">
        <option value="training">Entra√Ænement (avec explications)</option>
        <option value="exam">Examen (9 minutes, sans explications)</option>
      </select>
    </div>
    <button onclick="startQuiz()">üöÄ Commencer le test</button>
  </div>

  <div class="quiz-container" id="quizContainer">
    <div class="welcome" id="welcome">
      <h2 style="text-align:center;color:#667eea;margin-bottom:20px">Bienvenue !</h2>
      <p style="text-align:center;font-size:1.05em;color:#666;line-height:1.8">
        G√©n√©rateur cal√© sur le <strong>sujet officiel de SIXI√àME (mars 2020)</strong> : multiplications, partages, fractions,
        proportionnalit√©, conversions, suites de dur√©es, p√©rim√®tre, estimations, encadrements, pourcentages,
        produit cart√©sien (couleurs √ó tailles), etc.
      </p>
    </div>
  </div>
</div>

<script>
// ============== S√©curit√© de chargement KaTeX ==============
function whenKatexReady(cb){
  if (window.katex && typeof window.katex.render === 'function') { cb(); return; }
  window.addEventListener('load', function(){
    if (window.katex && typeof window.katex.render === 'function') cb();
    else console.error('KaTeX non charg√©.');
  });
}

// ============== Helpers g√©n√©raux ==============
function toFR(n, d = null){ if(typeof n === 'number') n = d!==null ? n.toFixed(d) : n.toString(); return n.replace('.', ','); }
function renderMath(x){ const span=document.createElement('span'); katex.render(x, span, {throwOnError:false}); return span.outerHTML; }
function renderMathBlock(x){ const div=document.createElement('div'); katex.render(x, div, {throwOnError:false, displayMode:true}); return div.outerHTML; }
function stepsHTML(steps){ return '<div class="math-steps">'+steps.map(s=>`<div class="math-step">${renderMath(s)}</div>`).join('')+'</div>'; }
function fmtTime(s){ const m=Math.floor(s/60), r=s%60; return m?`${m}min ${r}s`:`${r}s`; }
function isNumEq(a,b,tol=1e-9){ const na=Number(a), nb=Number(b); return Number.isFinite(na)&&Number.isFinite(nb)&&Math.abs(na-nb)<=tol; }
function normNumLike(s){ return s.toLowerCase().replace(',', '.').replace(/\s/g,'').replace(/‚Ç¨/g,'').replace(/%/g,''); }

let current=0, questions=[], answers=[], timer=null, elapsed=0, startedAt=0, times=[], examTimer=null, examLeft=540, hasAnswered=false;

// ============== G√©n√©rateur bas√© sur le sujet SIXI√àME (mars 2020) ==============
class Gen {
  rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a}
  rndf(a,b,d=2){const x=Math.random()*(b-a)+a;const k=10**d;return Math.round(x*k)/k}

  types(){
    return [
      'mult_basic',
      'factor_completion',
      'half_integer',
      'share_quotient_remainder',
      'add_two_integers',
      'days_to_hours',
      'sum_euros',
      'mental_3x25',
      'proportion_weight',
      'temp_increase',
      'compare_simple_fractions',
      'subtraction_thousands',
      'times_tens',
      'three_quarters_kg',
      'time_sequence_plus2',
      'twice_more_than',
      'between_3_9_and_4',
      'perimeter_square_dm',
      'nearest_estimation',
      'bound_fraction_consecutive',
      'unit_price_consistent',
      'two_representations_0_25',
      'times_ten',
      'percent_of_amount',
      'deciliter_to_liter',
      'product_cartesian'
    ]
  }

  pick(){const t=this.types();return t[this.rnd(0,t.length-1)]}

  next(){
    switch(this.pick()){
      case 'mult_basic': return this.mult_basic();
      case 'factor_completion': return this.factor_completion();
      case 'half_integer': return this.half_integer();
      case 'share_quotient_remainder': return this.share_qr();
      case 'add_two_integers': return this.add_two();
      case 'days_to_hours': return this.days_to_hours();
      case 'sum_euros': return this.sum_euros();
      case 'mental_3x25': return this.mental_3x25();
      case 'proportion_weight': return this.prop_weight();
      case 'temp_increase': return this.temp_increase();
      case 'compare_simple_fractions': return this.compare_simple_fr();
      case 'subtraction_thousands': return this.sub_thousands();
      case 'times_tens': return this.times_tens();
      case 'three_quarters_kg': return this.three_quarters_kg();
      case 'time_sequence_plus2': return this.time_seq_plus2();
      case 'twice_more_than': return this.twice_more();
      case 'between_3_9_and_4': return this.between_3_9_and_4();
      case 'perimeter_square_dm': return this.perimeter_square_dm();
      case 'nearest_estimation': return this.nearest_estimation();
      case 'bound_fraction_consecutive': return this.bound_fraction();
      case 'unit_price_consistent': return this.unit_price();
      case 'two_representations_0_25': return this.repr_0_25();
      case 'times_ten': return this.times_ten();
      case 'percent_of_amount': return this.percent_of_amount();
      case 'deciliter_to_liter': return this.dl_to_l();
      case 'product_cartesian': return this.prod_cartesian();
    }
  }

  mult_basic(){
    const a=this.rnd(3,9), b=this.rnd(3,9), r=a*b;
    return {question:`Calcule ${a} √ó ${b}`, answer:r.toString(), type:'numerical', explanationSteps:[`${a} \\times ${b} = ${r}`]};
  }

  factor_completion(){
    const n=this.rnd(12,30);
    const divs=[];for(let d=2;d<n;d++){if(n%d===0)divs.push(d)}
    const d=divs.length? divs[this.rnd(0,divs.length-1)]:1; const q=n/d;
    return {question:`Compl√®te : ${n} = ... √ó ...`, answer:`${d}√ó${q}`, type:'pattern', explanationSteps:[`${n} = ${d} \\times ${q}`]};
  }

  half_integer(){
    const n=this.rnd(10,60);
    return {question:`La moiti√© de ${n}`, answer:(n/2).toString(), type:'numerical', explanationSteps:[`\\dfrac{${n}}{2} = ${n/2}`]};
  }

  share_qr(){
    const people=this.rnd(6,12), coins=this.rnd(30,90);
    const q=Math.floor(coins/people), r=coins%people;
    return {question:`${people} pirates se partagent √©quitablement ${coins} pi√®ces d'or. Au maximum chacun re√ßoit ... pi√®ces et il reste ... pi√®ces. (r√©ponds ¬´ q, r ¬ª)`, answer:`${q},${r}`, type:'pair', explanationSteps:[`${coins} = ${people} \\times ${q} + ${r}`]};
  }

  add_two(){
    const a=this.rnd(10,60), b=this.rnd(10,60);
    return {question:`${a} + ${b}`, answer:(a+b).toString(), type:'numerical'};
  }

  days_to_hours(){
    const d=this.rnd(1,3);
    return {question:`Compl√®te : ${d} jour${d>1?'s':''} = ... heures`, answer:(d*24).toString(), type:'numerical', explanationSteps:[`${d} \\times 24 = ${d*24}`]};
  }

  sum_euros(){
    const a=10*this.rnd(1,9)+this.rnd(0,9);const b=10*this.rnd(1,9)+this.rnd(0,9);
    return {question:`J'ai re√ßu ${a} ‚Ç¨ puis ${b} ‚Ç¨. En tout j'ai re√ßu ... ‚Ç¨`, answer:(a+b).toString(), type:'numerical'};
  }

  mental_3x25(){
    const k=this.rnd(2,9);
    return {question:`Calcule ${k} √ó 25`, answer:(k*25).toString(), type:'numerical', explanationSteps:[`${k}\\times25 = ${k}\\times(100/4)= ${(k*100)}/4 = ${k*25}`]};
  }

  prop_weight(){
    const a=18, aw=100, b=9, bw=Math.round(aw*(b/a));
    return {question:`${a} billes p√®sent ${aw} g. ${b} billes p√®sent ... g`, answer:bw.toString(), type:'numerical', explanationSteps:[`${aw}\\,/\\,${a} = ${toFR(aw/a)}~g/\\text{bille}`,`\\Rightarrow ${b}~\\text{billes} = ${b}\\times${toFR(aw/a)} = ${toFR(bw)}~g`]};
  }

  temp_increase(){
    const t0=this.rnd(10,40), t1=this.rnd(120,220);
    return {question:`Mon four indiquait ${t0}¬∞C. Maintenant il indique ${t1}¬∞C. Il a augment√© de ... ¬∞C`, answer:(t1-t0).toString(), type:'numerical'};
  }

  compare_simple_fr(){
    const opts=[[1,3],[1,4],[1,5]];const labels=['1/3','un quart','1/5'];
    const i=this.rnd(0,2), j=(i+1)%3;
    const small=(opts[i][0]/opts[i][1] < opts[j][0]/opts[j][1])? labels[i] : labels[j];
    return {question:`Entoure le plus petit nombre : ${labels[i]} ; ${labels[j]}`, answer:small, type:'choice', explanationSteps:[`${labels[i]} = ${toFR(opts[i][0]/opts[i][1],2)},\\quad ${labels[j]} = ${toFR(opts[j][0]/opts[j][1],2)}`]};
  }

  sub_thousands(){
    const a=1000*this.rnd(2,5), b= this.rnd(500, a-100);
    return {question:`${a} ‚àí ${b}`, answer:(a-b).toString(), type:'numerical'};
  }

  times_tens(){
    const a=this.rnd(12,80), m=[10,20,30,40,50][this.rnd(0,4)];
    return {question:`${a} √ó ${m}`, answer:(a*m).toString(), type:'numerical', explanationSteps:[`${a}\\times${m} = ${a}\\times(${m/10}\\times10) = ${(a*(m/10))}\\times10 = ${a*m}`]};
  }

  three_quarters_kg(){
    return {question:`Les trois quarts de 1 kg = ... g`, answer:'750', type:'numerical', explanationSteps:[`\\dfrac{3}{4}\\times 1000 = 750\\,g`]};
  }

  time_seq_plus2(){
    const h=this.rnd(1,4), m=this.rnd(0,55);
    const m1=(m+2)%60;const h1=h+Math.floor((m+2)/60);
    const m2=(m+4)%60;const h2=h+Math.floor((m+4)/60);
    const nextH=h+Math.floor((m+6)/60), nextM=(m+6)%60;
    const fmt=(H,M)=>`${H}h${String(M).padStart(2,'0')}min`;
    return {question:`Compl√®te la suite logique : ${fmt(h,m)} ; ${fmt(h1,m1)} ; ${fmt(h2,m2)} ; ...`, answer:fmt(nextH,nextM), type:'time_format', explanationSteps:[`On ajoute 2 minutes √† chaque fois.`]};
  }

  twice_more(){
    const theo=[16,18,20,22][this.rnd(0,3)];
    return {question:`Th√©o p√®se ${theo} kg. Il p√®se 2 fois plus que sa s≈ìur Lise. Lise p√®se ... kg`, answer:(theo/2).toString(), type:'numerical'};
  }

  between_3_9_and_4(){
    const x=(Math.floor(Math.random()*10)+1)/100 + 3.9; // 3.91..3.99
    const ans= x.toFixed(2).replace('.',',');
    return {question:`Compl√®te par un nombre qui convient : 3,9 < ... < 4`, answer:ans.replace(',','.'), type:'text', explanationSteps:[`Tout nombre d√©cimal entre 3,90 et 4,00 convient, par ex. ${ans}.`]};
  }

  perimeter_square_dm(){
    const side=this.rnd(2,6);
    return {question:`Calcule le p√©rim√®tre de ce carr√© de c√¥t√© ${side} dm`, answer:(4*side).toString(), type:'numerical', unit:'dm', explanationSteps:[`P = 4\\times ${side} = ${4*side}\\,\\text{dm}`]};
  }

  nearest_estimation(){
    const a=this.rnd(31,79), b=this.rnd(81,99);
    const cand=[150,500,5000,800,3000];const prod=a*b;const nearest=cand.reduce((p,c)=>Math.abs(c-prod)<Math.abs(p-prod)?c:p,cand[0]);
    return {question:`Entoure le nombre le plus proche du r√©sultat de ${a}√ó${b} parmi : ${cand.join(', ')}`, answer:nearest.toString(), type:'choice', explanationSteps:[`\\text{Estimation : } ${a}\\approx${Math.round(a/10)*10},\\ ${b}\\approx${Math.round(b/10)*10}`]};
  }

  bound_fraction(){
    const num=this.rnd(5,11), den=this.rnd(3,9);const v=num/den;const lo=Math.floor(v), hi=lo+1;
    return {question:`Encadre la fraction par deux entiers cons√©cutifs : ... < ${num}/${den} < ... (r√©ponds ¬´ a,b ¬ª)`, answer:`${lo},${hi}`, type:'pair', explanationSteps:[`${num}/${den}=${toFR(v,2)}\\Rightarrow ${lo}<${num}/${den}<${hi}`]};
  }

  unit_price(){
    const price= [1,1.2,1.5,2][this.rnd(0,3)];const a=9, b=4, pa=(a*price).toFixed(2), pb=(b*price).toFixed(2), t=7, ans=(t*price).toFixed(2);
    return {question:`Toutes les balles sont au m√™me prix. ${a} balles co√ªtent ${pa} ‚Ç¨ et ${b} balles co√ªtent ${pb} ‚Ç¨. ${t} balles co√ªtent ... ‚Ç¨`, answer:ans, type:'money', explanationSteps:[`Prix unitaire = ${pa} / ${a} = ${price.toFixed(2)} ‚Ç¨ = ${pb} / ${b}`,`${t}\\times ${price.toFixed(2)} = ${ans} ‚Ç¨`]};
  }

  repr_0_25(){
    return {question:`Donne deux autres √©critures de 0,25 (r√©ponds ¬´ forme1 ; forme2 ¬ª)`, answer:`1/4;25%`, type:'text', explanationSteps:[`0,25 = \\dfrac{1}{4} = 25\\%`]};
  }

  times_ten(){
    const n=this.rnd(2,9);
    return {question:`Quel est le nombre 10 fois plus grand que ${n} ?`, answer:(n*10).toString(), type:'numerical'};
  }

  percent_of_amount(){
    const p=[10,20,25,50][this.rnd(0,3)], amt= [24,32,44,80,120][this.rnd(0,4)];
    const value=(p*amt)/100;                 // √©vite artefacts 0.2*24
    const answerStr=value.toFixed(2);        // format mon√©taire
    return {question:`Calcule ${p}% de ${amt} ‚Ç¨`, answer:answerStr, type:'numerical', unit:'‚Ç¨', explanationSteps:[`\\text{${p}% de } ${amt} = \\dfrac{${p}}{100} \\times ${amt}`,`= ${p}/100 \\times ${amt} = ${answerStr.replace('.',',')}\\,‚Ç¨`]};
  }

  dl_to_l(){
    const v=[5,10,15,20,30][this.rnd(0,4)];
    return {question:`Compl√®te : ${v} dL = ... L`, answer:(v/10).toString(), type:'numerical'};
  }

  prod_cartesian(){
    const c=this.rnd(3,6), t=this.rnd(2,4);
    return {question:`Une usine fabrique des cahiers : ${c} couleurs et ${t} tailles possibles. Combien de cahiers diff√©rents ?`, answer:(c*t).toString(), type:'numerical', explanationSteps:[`${c}\\times${t} = ${c*t}`]};
  }
}

// ============== Flux principal s√©curis√© (KaTeX pr√™t) ==============
function startQuiz(){
  whenKatexReady(() => {
    // Active auto-render si dispo
    if (typeof renderMathInElement === 'function') {
      renderMathInElement(document.body, {delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}]});
    }

    const count=parseInt(document.getElementById('questionCount').value);
    const mode=document.getElementById('mode').value;

    current=0;questions=[];answers=[];times=[];hasAnswered=false;
    if(mode==='exam'){examLeft=540;startExamTimer();}

    const g=new Gen();
    const seen=new Set();
    while(questions.length<count){
      const q=g.next();
      const key=q.question+'|'+(q.mathDisplay||'');
      if(!seen.has(key)){seen.add(key);questions.push(q)}
    }
    showQuestion();
  });
}

function startExamTimer(){clearInterval(examTimer);examTimer=setInterval(()=>{examLeft--;updateExamTimer();if(examLeft<=0){clearInterval(examTimer);autoFinish()}},1000)}
function updateExamTimer(){const el=document.getElementById('timer');if(!el)return;const m=Math.floor(examLeft/60),s=String(examLeft%60).padStart(2,'0');el.textContent=`‚è±Ô∏è ${m}:${s}`;if(examLeft<60){el.style.color='#dc3545';el.style.fontWeight='bold'}}
function autoFinish(){for(let i=current;i<questions.length;i++){answers.push({question:questions[i].question,userAnswer:'',correctAnswer:questions[i].answer,isCorrect:false,timeSpent:0,explanationSteps:questions[i].explanationSteps,unit:questions[i].unit})}showResults()}

function showQuestion(){
  if(current>=questions.length){clearInterval(examTimer);showResults();return}
  hasAnswered=false;startedAt=Date.now();
  const q=questions[current];const mode=document.getElementById('mode').value;const box=document.getElementById('quizContainer');
  let html=`<div class="question-header"><div class="question-number">Question ${current+1} / ${questions.length}</div><div class="timer" id="timer">‚è±Ô∏è ${mode==='exam'?`${Math.floor(examLeft/60)}:${String(examLeft%60).padStart(2,'0')}`:'0s'}</div></div>`
  if(mode==='exam') html+=`<div class="mode-info">‚ö†Ô∏è Mode Examen : 9 minutes ‚Äì pas d'explications affich√©es</div>`
  html+=`<div class="question-content"><div class="question-text">${q.question}</div>`
  if(q.mathDisplay) html+=`<div class="math-display">${renderMathBlock(q.mathDisplay)}</div>`

  let placeholder='Votre r√©ponse';
  if(q.unit) placeholder+=` (en ${q.unit})`;
  if(q.type==='pair') placeholder='R√©ponds au format q,r (ex: 5,3)';
  if(q.type==='time_format') placeholder='Format: 16h30min';

  html+=`<input type="text" class="answer-input" id="answerInput" placeholder="${placeholder}" onkeypress="if(event.key==='Enter') validateAnswer()"></div>`
  html+=`<div class="question-actions" id="questionActions"><button class="btn-validate" onclick="validateAnswer()">‚úì Valider</button><button class="btn-skip" onclick="skipQuestion()">‚Üí Passer</button></div><div id="feedback"></div>`
  box.innerHTML=html
  document.getElementById('answerInput').focus()
  if(mode==='training') startTimer(); else updateExamTimer()
}

function startTimer(){clearInterval(timer);elapsed=0;timer=setInterval(()=>{elapsed++;const el=document.getElementById('timer');if(el&&!hasAnswered)el.textContent=`‚è±Ô∏è ${elapsed}s`},1000)}

function validateAnswer(){if(hasAnswered)return;const mode=document.getElementById('mode').value;if(mode==='training')clearInterval(timer);hasAnswered=true
  const t=Math.round((Date.now()-startedAt)/1000);times.push(t)
  const input=document.getElementById('answerInput').value.trim();const q=questions[current];
  let ua=normNumLike(input), ca=normNumLike(q.answer)
  if(q.type==='time_format'){const fix=s=>s.replace(/(\\d+)h(\\d)(?!\\d)/,(m,H,mn)=>`${H}h0${mn}`).replace(/^(\\d+)h$/,'$1h00');ua=fix(ua);ca=fix(ca)}
  let ok;
  if(q.type==='numerical' || q.type==='time_format' || q.type==='money'){ok=isNumEq(ua,ca)}
  else if(q.type==='pair'){ok=ua===ca}
  else if(q.type==='choice' || q.type==='text' || q.type==='pattern'){ok=ua===ca}
  else {ok=ua===ca}

  answers.push({question:q.question,userAnswer:input,correctAnswer:q.answer,isCorrect:ok,timeSpent:t,explanationSteps:q.explanationSteps,unit:q.unit})

  if(mode==='training'){
    const fb=document.getElementById('feedback');fb.className='feedback '+(ok?'correct':'incorrect');
    const showAnswer=(q.unit==='‚Ç¨'&&typeof q.answer==='string')? q.answer.replace('.',',') : q.answer;
    let html = ok? `‚úì Correct ! (${t}s)` : `‚úó Incorrect. R√©ponse : ${showAnswer}${q.unit? ' '+q.unit:''} (${t}s)`
    if(q.explanationSteps){html+=`<div class="explanation-box ${ok?'correct':'incorrect'}"><strong>üìù Explication :</strong>${stepsHTML(q.explanationSteps)}</div>`}
    fb.innerHTML=html
    document.getElementById('questionActions').innerHTML='<button class="btn-next" onclick="nextQuestion()">Suivant ‚Üí</button>'
    document.getElementById('answerInput').disabled=true
  } else { nextQuestion() }
}

function skipQuestion(){if(hasAnswered)return;const mode=document.getElementById('mode').value;if(mode==='training')clearInterval(timer);hasAnswered=true
  const t=Math.round((Date.now()-startedAt)/1000);times.push(t)
  const q=questions[current]
  answers.push({question:q.question,userAnswer:'',correctAnswer:q.answer,isCorrect:false,timeSpent:t,explanationSteps:q.explanationSteps,unit:q.unit})
  if(mode==='training'){
    const fb=document.getElementById('feedback');fb.className='feedback incorrect';
    const showAnswer=(q.unit==='‚Ç¨'&&typeof q.answer==='string')? q.answer.replace('.',',') : q.answer;
    let html = `‚úó Question pass√©e. R√©ponse : ${showAnswer}${q.unit? ' '+q.unit:''} (${t}s)`
    if(q.explanationSteps){html+=`<div class="explanation-box incorrect"><strong>üìù Explication :</strong>${stepsHTML(q.explanationSteps)}</div>`}
    fb.innerHTML=html
    document.getElementById('questionActions').innerHTML='<button class="btn-next" onclick="nextQuestion()">Suivant ‚Üí</button>'
    document.getElementById('answerInput').disabled=true
  } else { nextQuestion() }
}

function nextQuestion(){current++;showQuestion()}

function showResults(){clearInterval(timer);clearInterval(examTimer)
  const good=answers.filter(a=>a.isCorrect).length;const pct=Math.round(100*good/questions.length)
  const total=times.reduce((a,b)=>a+b,0);const avg=questions.length? Math.round(total/questions.length):0
  const mode=document.getElementById('mode').value;const box=document.getElementById('quizContainer')
  let review='';answers.forEach((a,i)=>{review+=`<div class="question-review ${a.isCorrect?'correct':'incorrect'}"><strong>Q${i+1}:</strong> ${a.question}<br><strong>Votre r√©ponse:</strong> ${a.userAnswer||'‚Äî'}<br><strong>R√©ponse correcte:</strong> ${a.correctAnswer}${a.unit?' '+a.unit:''}<br>${mode==='training'?`<div class="time-info">‚è±Ô∏è ${a.timeSpent}s</div>`:''}${a.explanationSteps?`<div class="review-explanation"><strong>üìù Explication :</strong>${stepsHTML(a.explanationSteps)}</div>`:''}</div>`})
  let stats='';
  if(mode==='training'){
    stats=`<div style="background:#e3f2fd;padding:15px;border-radius:10px;margin:20px 0"><h3 style="color:#1976d2;margin-bottom:10px">üìä Statistiques de temps</h3><p style="font-size:1.05em;color:#333">Temps total : ${fmtTime(total)}<br>Temps moyen : ${avg}s<br>${times.length?`Plus rapide : ${Math.min(...times)}s<br>`:''}${times.length?`Plus long : ${Math.max(...times)}s`:''}</p></div>`
  } else {
    const used=540-examLeft;stats=`<div style="background:#fff3cd;padding:15px;border-radius:10px;margin:20px 0"><h3 style="color:#856404;margin-bottom:10px">‚è±Ô∏è Mode Examen</h3><p style="font-size:1.05em;color:#333">Temps utilis√© : ${fmtTime(used)} / 9 min</p></div>`
  }
  box.innerHTML=`<div class="results"><h2>üéØ R√©sultats</h2><div class="score">${good} / ${questions.length}</div><p style="font-size:1.1em;color:#666">Score : ${pct}%</p>${stats}<div class="results-details"><h3>üìã D√©tail des r√©ponses ${mode==='training'?'(avec explications)':''}</h3>${review}</div><button onclick="location.reload()">üîÑ Nouveau test</button></div>`
}

// ============== Init : attend KaTeX pour activer l'auto-render ==============
whenKatexReady(function(){
  if (typeof renderMathInElement === 'function') {
    renderMathInElement(document.body, {delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}]});
  }
});

// Expose global
window.startQuiz=startQuiz;window.validateAnswer=validateAnswer;window.skipQuestion=skipQuestion;window.nextQuestion=nextQuestion;
</script>
</body>
</html>
